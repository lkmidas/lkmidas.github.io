<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>GoogleCTF2021 - weather writeups - Midas Blog</title><meta name="Description" content="Writeup for GoogleCTF2021 weather challenge"><meta property="og:title" content="GoogleCTF2021 - weather writeups" />
<meta property="og:description" content="Writeup for GoogleCTF2021 weather challenge" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lkmidas.github.io/posts/20210719-ggctf2021-writeups/" /><meta property="og:image" content="https://lkmidas.github.io/images/avatar.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-19T19:40:02+07:00" />
<meta property="article:modified_time" content="2021-07-19T19:40:02+07:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://lkmidas.github.io/images/avatar.png"/>

<meta name="twitter:title" content="GoogleCTF2021 - weather writeups"/>
<meta name="twitter:description" content="Writeup for GoogleCTF2021 weather challenge"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://lkmidas.github.io/posts/20210719-ggctf2021-writeups/" /><link rel="prev" href="https://lkmidas.github.io/posts/20210517-omhctf2021-writeups/" /><link rel="next" href="https://lkmidas.github.io/posts/20220704-ggctf2022-writeups/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "GoogleCTF2021 - weather writeups",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/lkmidas.github.io\/posts\/20210719-ggctf2021-writeups\/"
        },"genre": "posts","wordcount":  4724 ,
        "url": "https:\/\/lkmidas.github.io\/posts\/20210719-ggctf2021-writeups\/","datePublished": "2021-07-19T19:40:02+07:00","dateModified": "2021-07-19T19:40:02+07:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Midas"
            },"description": "Writeup for GoogleCTF2021 weather challenge"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Midas Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" /></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Midas Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" /></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">GoogleCTF2021 - weather writeups</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Midas</a></span>&nbsp;<span class="post-category">included in <a href="/categories/writeups/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>writeups</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-07-19">2021-07-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;4724 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;23 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#analyzing-main-function">Analyzing main function</a></li>
    <li><a href="#analyzing-init-function">Analyzing init function</a></li>
    <li><a href="#analyzing-each-format-handler-function">Analyzing each format handler function</a></li>
    <li><a href="#writing-an-emulator--disassembler">Writing an emulator + disassembler</a></li>
    <li><a href="#analyze-the-first-code-block">Analyze the first code block</a></li>
    <li><a href="#analyze-the-decrypted-code-block">Analyze the decrypted code block</a></li>
    <li><a href="#inserting-z3">Inserting z3</a></li>
    <li><a href="#appendix">Appendix</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><em>Use the table of contents on the right to navigate to the section that you are interested in.</em></div>
        </div>
    </div>
<h2 id="introduction">Introduction</h2>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw" aria-hidden="true"></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ul>
<li><strong>Given files:</strong> <a href="/posts/20210719-ggctf2021-writeups/weather" rel="">weather</a>.</li>
<li><strong>Description:</strong> <code>I heard it's raining flags somewhere, but forgot where... Thankfully there's this weather database I can use.</code></li>
<li><strong>Category:</strong> Reverse engineering</li>
<li><strong>Summary</strong>: A VM reverse engineering challenge. This VM is created using custom <code>printf</code> formats. My solution is to build an emulator for it and use <code>z3</code> to solve it automatically without digging deep into the VM code.</li>
</ul>
</div>
        </div>
    </div>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw" aria-hidden="true"></i>TL;DR<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ol>
<li>Analyze the main function -&gt; pretty normal, can notice some unfamiliar <code>printf</code> formats.</li>
<li>Analyze the init function -&gt; learn that this program registers a bunch of new different <code>printf</code> formats.</li>
<li>Analyze each handler function -&gt; learn that most of them are used to create a register based VM.</li>
<li>Write an emulator + disassembler to analyze it -&gt; learn that the first block of VM code tries to decode a larger block of code using the first byte of our input.</li>
<li>Because this is a format string VM, the first byte of the block of code must be <code>%</code> -&gt; find out the first correct byte of the input is <code>T</code>.</li>
<li>Use the emulator + disassembler to analyze the decrypted code block -&gt; reach the check instruction.</li>
<li>Insert <code>z3</code> variables into the input bytes, change the emulator a bit -&gt; let <code>z3</code> solve the correct input automatically.</li>
<li>Run the original program, pass in the correct input -&gt; get flag</li>
</ol>
</div>
        </div>
    </div>
<h2 id="analyzing-main-function">Analyzing main function</h2>
<p>The <code>main</code> function is quite ordinary, it first reads in 100 bytes of input from the user and stores it at address <code>6080</code>. It then compares the input with some constant city names and prints the corresponding values. The interesting bit in <code>main</code> is that it uses some unfamiliar <code>printf</code> formats like <code>%P</code>, <code>%W</code>, <code>%T</code>, <code>%F</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span><span class="s">&#34;Precipitation: %P</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v7</span><span class="p">,</span> <span class="n">a4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span><span class="s">&#34;Wind: %W</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span><span class="s">&#34;Temperature: %T</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span><span class="s">&#34;Flag: %F</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">a4</span><span class="p">);</span>
</span></span></code></pre></div><p>When we run the program, it will print using these formats just fine, it means that these formats must be registered somewhere else in the binary. The oldest trick in the book to do this is to use the ELF <code>init</code> function.</p>
<h2 id="analyzing-init-function">Analyzing init function</h2>
<p>We can see a function <code>sub_2328</code> in <code>.init_array</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">init_register_printf</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;W&#39;</span><span class="p">,</span> <span class="n">format_W</span><span class="p">,</span> <span class="n">arginfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="n">format_P</span><span class="p">,</span> <span class="n">arginfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="n">format_T</span><span class="p">,</span> <span class="n">arginfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="n">format_F</span><span class="p">,</span> <span class="n">arginfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="n">format_C_jcc</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="n">format_M_load</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="n">format_S_add</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;O&#39;</span><span class="p">,</span> <span class="n">format_O_sub</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="n">format_X_mult</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="n">format_V_div</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="n">format_N_mod</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="n">format_L_lshift</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="n">format_R_rshift</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="n">format_E_xor</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="n">format_I_and</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">register_printf_function</span><span class="p">(</span><span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="n">format_U_or</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This function uses <code>register_printf_function</code> to register new formats for <code>printf</code>, more about it can be found <a href="https://www.gnu.org/software/libc/manual/html_node/Registering-New-Conversions.html" target="_blank" rel="noopener noreffer ">here</a>. The most important parts are the first and second parameters to it. The first one is a single <code>char</code>, which is the new format, and the second one is the handler function for that format. So it is clear that the job now is to reverse each of them.</p>
<h2 id="analyzing-each-format-handler-function">Analyzing each format handler function</h2>
<p>There are 16 new formats registered, I will explain each of them:</p>
<ul>
<li><code>%W</code>, <code>%P</code> and <code>%T</code> are pretty standard, they are just wrappers around traditional <code>printf</code> formats.</li>
<li><code>%F</code> is also a wrapper around other <code>printf</code> formats, but it uses <code>%C</code>, which is a new format.</li>
<li><code>%C</code> is where it gets interesting. In this handler function we can see that instead of using the <code>printf</code>&rsquo;s <code>args</code>, it uses the <code>info</code> instead.</li>
</ul>
<p>The struct definition for <code>printf_info</code> can be found <a href="https://code.woboq.org/userspace/glibc/stdio-common/printf.h.html" target="_blank" rel="noopener noreffer ">here</a> and it&rsquo;s documentation can be found <a href="https://www.gnu.org/software/libc/manual/html_node/Conversion-Specifier-Options.html" target="_blank" rel="noopener noreffer ">here</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">printf_info</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">prec</span><span class="p">;</span>                        <span class="cm">/* Precision.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">width</span><span class="p">;</span>                        <span class="cm">/* Width.  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">wchar_t</span> <span class="n">spec</span><span class="p">;</span>                        <span class="cm">/* Format letter.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">is_long_double</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span><span class="cm">/* L flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">is_short</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>        <span class="cm">/* h flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">is_long</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>        <span class="cm">/* l flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">alt</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                <span class="cm">/* # flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">space</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                <span class="cm">/* Space flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">left</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                <span class="cm">/* - flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">showsign</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>        <span class="cm">/* + flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">group</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                <span class="cm">/* &#39; flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">extra</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                <span class="cm">/* For special use.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">is_char</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>        <span class="cm">/* hh flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">wide</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                <span class="cm">/* Nonzero for wide character streams.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">i18n</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                <span class="cm">/* I flag.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">is_binary128</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>        <span class="cm">/* Floating-point argument is ABI-compatible
</span></span></span><span class="line"><span class="cl"><span class="cm">                                   with IEC 60559 binary128.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">__pad</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span>                <span class="cm">/* Unused so far.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">user</span><span class="p">;</span>        <span class="cm">/* Bits for user-installed modifiers.  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">wchar_t</span> <span class="n">pad</span><span class="p">;</span>                        <span class="cm">/* Padding character.  */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>I will explain the fields that our binary uses:</p>
<ul>
<li><code>width</code> is the width of the string to be printed with the format, for example: <code>%69x</code> results in <code>info-&gt;width = 69</code>. By default if width is not specified then it&rsquo;s 0.</li>
<li><code>prec</code> is the precision of a non-integer number, for example <code>%.69f</code> results in <code>info-&gt;prec = 69</code>. By default this is -1.</li>
<li><code>is_long_double</code>, <code>is_short</code>, <code>is_long</code> and <code>is_char</code> are 1-bit fields that correspond to the flags <code>ll</code>, <code>h</code>, <code>l</code>, <code>hh</code>, respectively, before the format type. Only one of these bit can be 1 at a time, for example: <code>%lx</code> sets <code>info-&gt;is_long</code> to 1 and the rest to 0.</li>
<li><code>left</code>, <code>showsign</code> are also 1-bit fields that correspond to the flags <code>-</code> and <code>+</code> at the start of the format, right after <code>%</code>. Only one of these two can be 1 at a time, for example <code>%+6x</code> or <code>%-9x</code>.</li>
<li><code>pad</code> is the padding character and can only be either whitespace (<code>' '</code>) or zero (<code>'0'</code>), default to whitespace. The first byte after <code>%</code> or <code>+/-</code> will determine this, if it&rsquo;s <code>0</code> then <code>info-&gt;pad = '0'</code>, for example: <code>%69x</code> is whitespace-padded and <code>%069</code> is 0-padded.</li>
</ul>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><em>You may be unfamiliar with the <code>:1</code> after field names. This in C is used to define bit fields. For example: all 8 fields from <code>is_long_double</code> to <code>group</code> are only 1 bit in size, so they all will be stored in 1 single byte instead of 8 different bytes for memory optimization.</em></div>
        </div>
    </div>
<p>With the above knowledge, let&rsquo;s get back to the registered <code>printf</code> formats:</p>
<ul>
<li><code>%C</code> is easier to understand now, it uses <code>left</code>, <code>showsign</code> and <code>pad</code> fields to determine the type of comparison. Afterwards, it uses the comparison result to decide to call another <code>fprintf</code> or not (all functions in <code>printf</code> family shares the registered format handlers). Notice that there are 2 different memory regions that are accessed here: one is 32-bit accessed in the comparison at address <code>70A0</code>, I called it <code>REGS</code>; the other is 8-bit accessed and contains other format strings at address <code>5080</code>, I called it <code>MEM</code>. So this <code>%C</code> format is basically a conditional call function that implements 4 different calls, I name them <code>CLZ</code>, <code>CGZ</code>, <code>CEZ</code> and <code>CALL</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">format_C_call</span><span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">printf_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">prec</span><span class="p">;</span> <span class="c1">// [rsp+24h] [rbp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_BOOL4</span> <span class="n">cmp_flag</span><span class="p">;</span> <span class="c1">// [rsp+2Ch] [rbp-4h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">prec</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">prec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>    <span class="c1">// - flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmp_flag</span> <span class="o">=</span> <span class="n">REGISTERS</span><span class="p">[</span><span class="n">prec</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span><span class="c1">// + flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmp_flag</span> <span class="o">=</span> <span class="n">REGISTERS</span><span class="p">[</span><span class="n">prec</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="p">)</span>                  <span class="c1">// padding char
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmp_flag</span> <span class="o">=</span> <span class="n">REGISTERS</span><span class="p">[</span><span class="n">prec</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmp_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">cmp_flag</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">MEM</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>All the other formats follows the same structure, which uses <code>left</code> and <code>showsign</code> fields to get an address, and <code>is_long_double</code>, <code>is_short</code>, <code>is_long</code>, <code>is_char</code> fields to get a value. It then performs an arithmetic operation on what is at the address and the value and store the result back to address. The operations are: <code>%M - load</code>, <code>%S - add</code>, <code>%O - sub</code>, <code>%X - mult</code>, <code>%V - div</code>, <code>%N - mod</code>, <code>L - left shift</code>, <code>R - right shift</code>, <code>E - xor</code>, <code>I - and</code>, <code>U - or</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">format_M_load</span><span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">printf_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">prec</span><span class="p">;</span> <span class="c1">// [rsp+24h] [rbp-14h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">width</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-10h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">val</span><span class="p">;</span> <span class="c1">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span> <span class="c1">// [rsp+30h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">width</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">prec</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">prec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>    <span class="c1">// - flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">MEM</span><span class="p">[</span><span class="n">width</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span><span class="c1">// + flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">MEM</span><span class="p">[</span><span class="n">REGISTERS</span><span class="p">[</span><span class="n">width</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">REGISTERS</span><span class="p">[</span><span class="n">width</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>       <span class="c1">// hh flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">MEM</span><span class="p">[</span><span class="n">prec</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1">// h flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">MEM</span><span class="p">[</span><span class="n">REGISTERS</span><span class="p">[</span><span class="n">prec</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1">// L flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">prec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>  <span class="c1">// l flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="n">REGISTERS</span><span class="p">[</span><span class="n">prec</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>So in summary, these formats defined a VM as follow: A register-based VM that operates on a set of 32-bit registers and an 8-bit accessed memory. It has 11x3x4 arithmetic instructions and 4 call instructions. However, there is one more instruction that is not explicitly defined which is <code>RET</code>. After all, this VM operates on <code>printf</code>, and <code>printf</code> will stop printing at the end of a string. Therefore, a null byte <code>\x00</code> can be understood as a <code>RET</code> instruction. The binary will jump into this VM using the <code>printf</code> format <code>%F</code>, which then call <code>printf</code> format <code>%52C</code>, which means an unconditional <code>CALL</code> to <code>MEM[52]</code>.</p>
<h2 id="writing-an-emulator--disassembler">Writing an emulator + disassembler</h2>
<p>Emulating unfamiliar instruction sets is actually one of my interest, so immediately I decided to solve this challenge using an emulator. The first step is to parse each format strings into different fields. My method is a naive one but it works in this case, the steps are:</p>
<ol>
<li>Initiating all fields with there default values.</li>
<li>Get the first byte after <code>%</code>, if it&rsquo;s <code>+</code> then set <code>showsign</code> to 1, if it&rsquo;s <code>-</code> then set <code>left</code> to 1.</li>
<li>Get the next byte after that, if it&rsquo;s <code>0</code> then set pad to <code>'0'</code>.</li>
<li>If <code>hh</code> is in the string, set <code>hh</code> to 1, goto step 8.</li>
<li>If <code>h</code> is in the string, set <code>h</code> to 1, goto step 8.</li>
<li>If <code>ll</code> is in the string, set <code>L</code> to 1, goto step 8.</li>
<li>If <code>l</code> is in the string, set <code>l</code> to 1.</li>
<li>Get the format type as the last character of the string.</li>
<li>If <code>.</code> is in the string, goto 12.</li>
<li>From the bottom up, remove all non-digit characters.</li>
<li>What is left is <code>width</code>, end.</li>
<li>Split the string by <code>.</code>, the first half is <code>width</code> if it&rsquo;s not empty.</li>
<li>From the bottom up of the second half, remove all non-digit characters.</li>
<li>What is left is <code>prec</code>, end.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_fmt</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">typ</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">prec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">pad</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">left</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">showsign</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">L</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">l</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">hh</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;+&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">showsign</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;-&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">left</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;0&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pad</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s2">&#34;hh&#34;</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">hh</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="s2">&#34;h&#34;</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="p">(</span><span class="s2">&#34;ll&#34;</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&#34;L&#34;</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">L</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="s2">&#34;l&#34;</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">l</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">typ</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s2">&#34;.&#34;</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fmt1</span><span class="p">,</span> <span class="n">fmt2</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fmt1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fmt1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="n">fmt2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt2</span> <span class="o">=</span> <span class="n">fmt2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">prec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fmt2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="n">fmt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span><span class="p">)</span>
</span></span></code></pre></div><p>With all the fields parsed, we can emulates the instructions easily using the knowledge from the last section. There is a little gimmick here about memory access, because accessing <code>MEM</code> is by 8-bit and <code>REGS</code> is by 32-bit, but the arithmetic instructions treat both of them the same way. Therefore, I have to define both of them as 8-bit arrays and use 2 helper functions <code>load32</code> and <code>store32</code> to access the registers.</p>
<p>The code for emulating is quite lengthy but straight-forward, everything that needs to be known to implement it has been explained, so I will just leave the code here without explaining more about it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exec_calc</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">where</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_where</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_addr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_val</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="n">width</span>
</span></span><span class="line"><span class="cl">        <span class="n">where</span> <span class="o">=</span> <span class="n">mem</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_where</span> <span class="o">=</span> <span class="s2">&#34;MEM&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_addr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">showsign</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">width</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">where</span> <span class="o">=</span> <span class="n">mem</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_where</span> <span class="o">=</span> <span class="s2">&#34;MEM&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_addr</span> <span class="o">=</span> <span class="s2">&#34;REGS[</span><span class="si">{}</span><span class="s2">]&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="n">width</span><span class="o">*</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="n">where</span> <span class="o">=</span> <span class="n">regs</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_where</span> <span class="o">=</span> <span class="s2">&#34;REGS&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_addr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">hh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_val</span> <span class="o">=</span> <span class="s2">&#34;MEM[</span><span class="si">{}</span><span class="s2">]&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">h</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">load32</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">prec</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_val</span> <span class="o">=</span> <span class="s2">&#34;MEM[REGS[</span><span class="si">{}</span><span class="s2">]]&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">L</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">prec</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">l</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">prec</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_val</span> <span class="o">=</span> <span class="s2">&#34;REGS[</span><span class="si">{}</span><span class="s2">]&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">left</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">right</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;M&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;LOAD&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;S&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;ADD&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;O&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;SUB&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;X&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;MULT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;V&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">//</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;DIV&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;N&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">%</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;MOD&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;L&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;LSHIFT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;R&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;RSHIFT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;E&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;XOR&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;I&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;AND&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;U&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;OR&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;UNKNOWN TYPE&#34;</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">store32</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">], </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbg_cmd</span><span class="p">,</span> <span class="n">dbg_where</span><span class="p">,</span> <span class="n">dbg_addr</span><span class="p">,</span> <span class="n">dbg_val</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;# addr = </span><span class="si">{}</span><span class="s2">, val_1 = </span><span class="si">{}</span><span class="s2">, val_2 = </span><span class="si">{}</span><span class="s2">, result = </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">right</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exec_call</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s2">&#34;C&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;UNKNOWN TYPE&#34;</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">cmp_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_reg</span> <span class="o">=</span> <span class="n">prec</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_addr</span> <span class="o">=</span> <span class="n">width</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmp_flag</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">prec</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x7fffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;CLZ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">showsign</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmp_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">load32</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">prec</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">load32</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">prec</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;CGZ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">pad</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmp_flag</span> <span class="o">=</span> <span class="n">load32</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">prec</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;CEZ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmp_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;CALL&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2"> REGS[</span><span class="si">{}</span><span class="s2">], </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbg_cmd</span><span class="p">,</span> <span class="n">dbg_reg</span><span class="p">,</span> <span class="n">dbg_addr</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;# val = </span><span class="si">{}</span><span class="s2">, cmp_flag = </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">load32</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">prec</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="n">cmp_flag</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">cmp_flag</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">execute</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">init_pc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">regs</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">    <span class="n">pc</span> <span class="o">=</span> <span class="n">init_pc</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">next_pc</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;%&#34;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pc</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="p">:</span><span class="n">next_pc</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">            <span class="n">null</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pc</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span> <span class="c1"># At the end no more %</span>
</span></span><span class="line"><span class="cl">            <span class="n">null</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pc</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="p">:</span><span class="n">null</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">            <span class="n">next_pc</span> <span class="o">=</span> <span class="n">null</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">pc</span> <span class="o">=</span> <span class="n">next_pc</span>
</span></span><span class="line"><span class="cl">        <span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span> <span class="o">=</span> <span class="n">parse_fmt</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;C&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">exec_call</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">exec_calc</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">next_pc</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">null</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">null</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;RET&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span></code></pre></div><p>The disassembler is basically the same as the emulator, except that instead of doing load/store/calculations/calls, we just decode the instruction and continue to the next one.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">disass_calc</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">where</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_where</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_addr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_val</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_where</span> <span class="o">=</span> <span class="s2">&#34;MEM&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_addr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">showsign</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_where</span> <span class="o">=</span> <span class="s2">&#34;MEM&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_addr</span> <span class="o">=</span> <span class="s2">&#34;REGS[</span><span class="si">{}</span><span class="s2">]&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_where</span> <span class="o">=</span> <span class="s2">&#34;REGS&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_addr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">hh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_val</span> <span class="o">=</span> <span class="s2">&#34;MEM[</span><span class="si">{}</span><span class="s2">]&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">h</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_val</span> <span class="o">=</span> <span class="s2">&#34;MEM[REGS[</span><span class="si">{}</span><span class="s2">]]&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">L</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">l</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_val</span> <span class="o">=</span> <span class="s2">&#34;REGS[</span><span class="si">{}</span><span class="s2">]&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;M&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;LOAD&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;S&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;ADD&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;O&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;SUB&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;X&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;MULT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;V&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;DIV&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;N&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;MOD&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;L&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;LSHIFT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;R&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;RSHIFT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;E&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;XOR&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;I&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;AND&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;U&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;OR&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;UNKNOWN TYPE&#34;</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">], </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbg_cmd</span><span class="p">,</span> <span class="n">dbg_where</span><span class="p">,</span> <span class="n">dbg_addr</span><span class="p">,</span> <span class="n">dbg_val</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">disass_call</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s2">&#34;C&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;UNKNOWN TYPE&#34;</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">cmp_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_reg</span> <span class="o">=</span> <span class="n">prec</span>
</span></span><span class="line"><span class="cl">    <span class="n">dbg_addr</span> <span class="o">=</span> <span class="n">width</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;CLZ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">showsign</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;CGZ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">pad</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;CEZ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">dbg_cmd</span> <span class="o">=</span> <span class="s2">&#34;CALL&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2"> REGS[</span><span class="si">{}</span><span class="s2">], </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbg_cmd</span><span class="p">,</span> <span class="n">dbg_reg</span><span class="p">,</span> <span class="n">dbg_addr</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">disass</span><span class="p">(</span><span class="n">init_pc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">regs</span><span class="p">,</span> <span class="n">mem</span>
</span></span><span class="line"><span class="cl">    <span class="n">pc</span> <span class="o">=</span> <span class="n">init_pc</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">next_pc</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;%&#34;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pc</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="p">:</span><span class="n">next_pc</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">            <span class="n">null</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pc</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span> <span class="c1"># At the end no more %</span>
</span></span><span class="line"><span class="cl">            <span class="n">null</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pc</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mem</span><span class="p">[</span><span class="n">pc</span><span class="p">:</span><span class="n">null</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">            <span class="n">next_pc</span> <span class="o">=</span> <span class="n">null</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&#34;%&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">pc</span> <span class="o">=</span> <span class="n">next_pc</span>
</span></span><span class="line"><span class="cl">        <span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span> <span class="o">=</span> <span class="n">parse_fmt</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&#34;C&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">disass_call</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">disass_calc</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">showsign</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">hh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">next_pc</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">null</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">null</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;RET</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="analyze-the-first-code-block">Analyze the first code block</h2>
<p>When I was solving this challenge, I actually mostly used just the emulator and only look at the code where it stucks. But in this writeups, I will explain the code by disassembling them instead of saying &ldquo;just run the emulator&rdquo;.</p>
<p>Remembering that the VM starts executing by a <code>%52C</code> call, I disassembled <code>MEM[52]</code> to see what code is there:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="m">52</span>        %0.4096hhM                    LOAD REGS<span class="o">[</span>0<span class="o">]</span>, MEM<span class="o">[</span>4096<span class="o">]</span>       
</span></span><span class="line"><span class="cl"><span class="m">62</span>        %0.255llI                     AND REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">255</span>              
</span></span><span class="line"><span class="cl"><span class="m">71</span>        %1.0lM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">77</span>        %1.8llL                       LSHIFT REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">8</span>             
</span></span><span class="line"><span class="cl"><span class="m">84</span>        %0.1lU                        OR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>           
</span></span><span class="line"><span class="cl"><span class="m">90</span>        %1.0lM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">96</span>        %1.16llL                      LSHIFT REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">16</span>            
</span></span><span class="line"><span class="cl"><span class="m">104</span>       %0.1lU                        OR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>           
</span></span><span class="line"><span class="cl"><span class="m">110</span>       %1.200llM                     LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">200</span>             
</span></span><span class="line"><span class="cl"><span class="m">119</span>       %2.1788llM                    LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1788</span>            
</span></span><span class="line"><span class="cl"><span class="m">129</span>       %7C                           CALL REGS<span class="o">[</span>-1<span class="o">]</span>, <span class="m">7</span>              
</span></span><span class="line"><span class="cl"><span class="m">132</span>       %-6144.1701736302llM          LOAD MEM<span class="o">[</span>6144<span class="o">]</span>, <span class="m">1701736302</span>    
</span></span><span class="line"><span class="cl"><span class="m">152</span>       %0.200hhM                     LOAD REGS<span class="o">[</span>0<span class="o">]</span>, MEM<span class="o">[</span>200<span class="o">]</span>        
</span></span><span class="line"><span class="cl"><span class="m">161</span>       %0.255llI                     AND REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">255</span>              
</span></span><span class="line"><span class="cl"><span class="m">170</span>       %0.37llO                      SUB REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">37</span>               
</span></span><span class="line"><span class="cl"><span class="m">178</span>       %0200.0C                      CEZ REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">200</span>              
</span></span><span class="line"><span class="cl"><span class="m">186</span>       RET
</span></span></code></pre></div><p>The access to <code>MEM[4096]</code> looks sus, but recall that <code>MEM</code> is at address <code>5080</code>, so <code>MEM[4096]</code> will be at <code>6080</code>. If you have a good memory, in the first section where we analyzed <code>main</code>, this is the address of our input! So basically this first few instructions will read the first 4 bytes of our input, then reduce it to the first 1 byte to save in <code>REGS[0]</code>, then load 200 to <code>REGS[1]</code>, 1788 to <code>REGS[2]</code> and call <code>%7C</code>. Let&rsquo;s disassemble at <code>MEM[7]</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="m">7</span>         %3.1hM                        LOAD REGS<span class="o">[</span>3<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">13</span>        %3.0lE                        XOR REGS<span class="o">[</span>3<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">19</span>        %+1.3lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>, REGS<span class="o">[</span>3<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">26</span>        %1.4llS                       ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4</span>                
</span></span><span class="line"><span class="cl"><span class="m">33</span>        %3.1lM                        LOAD REGS<span class="o">[</span>3<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">39</span>        %3.2lO                        SUB REGS<span class="o">[</span>3<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">45</span>        %-7.3C                        CLZ REGS<span class="o">[</span>3<span class="o">]</span>, <span class="m">7</span>                
</span></span><span class="line"><span class="cl"><span class="m">51</span>        RET
</span></span></code></pre></div><p>We can see that <code>REGS[1]</code> is used as an index to <code>MEM</code> and <code>REGS[2]</code> is used as a counter. If we look in the binary at <code>MEM[200]</code>, it contains a bunch of weird bytes that looks like encrypted data. This code at <code>MEM[7]</code> basically decrypt that block of encrypted data using <code>REGS[0]</code> as the key, which is the first byte of our input.</p>
<p>After finishing decrypting the data, it returns back to <code>MEM[132]</code>, this instruction loads the string <code>&quot;none&quot;</code> to <code>MEM[6144]</code>. Because when we run the binary normally and pass in a random input, it prints out <code>Flag: none</code>, so <code>MEM[6144]</code> will probably contain the flag. The VM then compares the value at <code>MEM[200]</code> to 37 and calls to it if they are equal. The value 37 is actually the ASCII value of <code>'%'</code>, so with this we can retrieve the first correct byte of our input by XORing 37 with the first byte in the encrypted data, resulting in the character <code>'T'</code>.</p>
<p>After knowing the first correct byte is <code>'T'</code>, I reran the emulator and indeed it called to <code>MEM[200]</code>. Let&rsquo;s analyze this block of code.</p>
<h2 id="analyze-the-decrypted-code-block">Analyze the decrypted code block</h2>
<p>The disassembly result:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="m">200</span>       %4.5000llM                    LOAD REGS<span class="o">[</span>4<span class="o">]</span>, <span class="m">5000</span>            
</span></span><span class="line"><span class="cl"><span class="m">210</span>       %0.13200llM                   LOAD REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">13200</span>           
</span></span><span class="line"><span class="cl"><span class="m">221</span>       %337C                         CALL REGS<span class="o">[</span>-1<span class="o">]</span>, <span class="m">337</span>            
</span></span><span class="line"><span class="cl"><span class="m">226</span>       %0.0llM                       LOAD REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">233</span>       %500C                         CALL REGS<span class="o">[</span>-1<span class="o">]</span>, <span class="m">500</span>            
</span></span><span class="line"><span class="cl"><span class="m">238</span>       %1262C                        CALL REGS<span class="o">[</span>-1<span class="o">]</span>, <span class="m">1262</span>           
</span></span><span class="line"><span class="cl"><span class="m">244</span>       %0653.0C                      CEZ REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">653</span>              
</span></span><span class="line"><span class="cl"><span class="m">252</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">253</span>       %1.0llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">260</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">261</span>       %3.0lM                        LOAD REGS<span class="o">[</span>3<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">267</span>       %3.2lN                        MOD REGS<span class="o">[</span>3<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">273</span>       %0253.3C                      CEZ REGS<span class="o">[</span>3<span class="o">]</span>, <span class="m">253</span>              
</span></span><span class="line"><span class="cl"><span class="m">281</span>       %2.1llS                       ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1</span>                
</span></span><span class="line"><span class="cl"><span class="m">288</span>       %3.2lM                        LOAD REGS<span class="o">[</span>3<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">294</span>       %3.3lX                        MULT REGS<span class="o">[</span>3<span class="o">]</span>, REGS<span class="o">[</span>3<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">300</span>       %3.0lO                        SUB REGS<span class="o">[</span>3<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">306</span>       %3.1llO                       SUB REGS<span class="o">[</span>3<span class="o">]</span>, <span class="m">1</span>                
</span></span><span class="line"><span class="cl"><span class="m">313</span>       %-261.3C                      CLZ REGS<span class="o">[</span>3<span class="o">]</span>, <span class="m">261</span>              
</span></span><span class="line"><span class="cl"><span class="m">321</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">322</span>       %+4.0lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>4<span class="o">]]</span>, REGS<span class="o">[</span>0<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">329</span>       %4.2llS                       ADD REGS<span class="o">[</span>4<span class="o">]</span>, <span class="m">2</span>                
</span></span><span class="line"><span class="cl"><span class="m">336</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">337</span>       %1.1llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">1</span>               
</span></span><span class="line"><span class="cl"><span class="m">344</span>       %2.2llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">2</span>               
</span></span><span class="line"><span class="cl"><span class="m">351</span>       %261C                         CALL REGS<span class="o">[</span>-1<span class="o">]</span>, <span class="m">261</span>            
</span></span><span class="line"><span class="cl"><span class="m">356</span>       %+322.1C                      CGZ REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">322</span>              
</span></span><span class="line"><span class="cl"><span class="m">364</span>       %0.1llS                       ADD REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">1</span>                
</span></span><span class="line"><span class="cl"><span class="m">371</span>       %1.13600llM                   LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">13600</span>           
</span></span><span class="line"><span class="cl"><span class="m">382</span>       %1.0lO                        SUB REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">388</span>       %+337.1C                      CGZ REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">337</span>              
</span></span><span class="line"><span class="cl"><span class="m">396</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">397</span>       %0.0llM                       LOAD REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">404</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">405</span>       %0.2llV                       DIV REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">2</span>                
</span></span><span class="line"><span class="cl"><span class="m">412</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">413</span>       %0.3llX                       MULT REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">3</span>               
</span></span><span class="line"><span class="cl"><span class="m">420</span>       %0.1llS                       ADD REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">1</span>                
</span></span><span class="line"><span class="cl"><span class="m">427</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">428</span>       %1.0lM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">434</span>       %1.2llN                       MOD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">2</span>                
</span></span><span class="line"><span class="cl"><span class="m">441</span>       %0405.1C                      CEZ REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">405</span>              
</span></span><span class="line"><span class="cl"><span class="m">449</span>       %+413.1C                      CGZ REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">413</span>              
</span></span><span class="line"><span class="cl"><span class="m">457</span>       %470C                         CALL REGS<span class="o">[</span>-1<span class="o">]</span>, <span class="m">470</span>            
</span></span><span class="line"><span class="cl"><span class="m">462</span>       %0.1llS                       ADD REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">1</span>                
</span></span><span class="line"><span class="cl"><span class="m">469</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">470</span>       %1.0lM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">476</span>       %1.1llO                       SUB REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">1</span>                
</span></span><span class="line"><span class="cl"><span class="m">483</span>       %0397.1C                      CEZ REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">397</span>              
</span></span><span class="line"><span class="cl"><span class="m">491</span>       %+428.1C                      CGZ REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">428</span>              
</span></span><span class="line"><span class="cl"><span class="m">499</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">500</span>       %2.0lM                        LOAD REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">506</span>       %2.4096llS                    ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">4096</span>             
</span></span><span class="line"><span class="cl"><span class="m">516</span>       %4.2hM                        LOAD REGS<span class="o">[</span>4<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>2<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">522</span>       %4.255llI                     AND REGS<span class="o">[</span>4<span class="o">]</span>, <span class="m">255</span>              
</span></span><span class="line"><span class="cl"><span class="m">531</span>       %+540.4C                      CGZ REGS<span class="o">[</span>4<span class="o">]</span>, <span class="m">540</span>              
</span></span><span class="line"><span class="cl"><span class="m">539</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">540</span>       %2.0lM                        LOAD REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">546</span>       %2.2llX                       MULT REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">2</span>               
</span></span><span class="line"><span class="cl"><span class="m">553</span>       %2.5000llS                    ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">5000</span>             
</span></span><span class="line"><span class="cl"><span class="m">563</span>       %2.2hM                        LOAD REGS<span class="o">[</span>2<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>2<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">569</span>       %2.255llI                     AND REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">255</span>              
</span></span><span class="line"><span class="cl"><span class="m">578</span>       %4.2lE                        XOR REGS<span class="o">[</span>4<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">584</span>       %0.1llS                       ADD REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">1</span>                
</span></span><span class="line"><span class="cl"><span class="m">591</span>       %2.0lM                        LOAD REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">597</span>       %470C                         CALL REGS<span class="o">[</span>-1<span class="o">]</span>, <span class="m">470</span>            
</span></span><span class="line"><span class="cl"><span class="m">602</span>       %4.0lS                        ADD REGS<span class="o">[</span>4<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">608</span>       %4.255llI                     AND REGS<span class="o">[</span>4<span class="o">]</span>, <span class="m">255</span>              
</span></span><span class="line"><span class="cl"><span class="m">617</span>       %0.2lM                        LOAD REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>         
</span></span><span class="line"><span class="cl"><span class="m">623</span>       %2.1llO                       SUB REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1</span>                
</span></span><span class="line"><span class="cl"><span class="m">630</span>       %2.4500llS                    ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">4500</span>             
</span></span><span class="line"><span class="cl"><span class="m">640</span>       %+2.4lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>2<span class="o">]]</span>, REGS<span class="o">[</span>4<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">647</span>       %500C                         CALL REGS<span class="o">[</span>-1<span class="o">]</span>, <span class="m">500</span>            
</span></span><span class="line"><span class="cl"><span class="m">652</span>       RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">653</span>       %0.123456789llM               LOAD REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">123456789</span>       
</span></span><span class="line"><span class="cl"><span class="m">668</span>       %1.0llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">675</span>       %1.4096llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4096</span>             
</span></span><span class="line"><span class="cl"><span class="m">685</span>       %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">691</span>       %0.1lE                        XOR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">697</span>       %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">704</span>       %2.846786818llS               ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">846786818</span>        
</span></span><span class="line"><span class="cl"><span class="m">719</span>       %2.0lE                        XOR REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">725</span>       %1.0llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">732</span>       %1.6144llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">6144</span>             
</span></span><span class="line"><span class="cl"><span class="m">742</span>       %+1.2lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>, REGS<span class="o">[</span>2<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">749</span>       %1.4llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4</span>               
</span></span><span class="line"><span class="cl"><span class="m">756</span>       %1.4096llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4096</span>             
</span></span><span class="line"><span class="cl"><span class="m">766</span>       %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">772</span>       %0.1lE                        XOR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">778</span>       %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">785</span>       %2.1443538759llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1443538759</span>       
</span></span><span class="line"><span class="cl"><span class="m">801</span>       %2.0lE                        XOR REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">807</span>       %1.4llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4</span>               
</span></span><span class="line"><span class="cl"><span class="m">814</span>       %1.6144llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">6144</span>             
</span></span><span class="line"><span class="cl"><span class="m">824</span>       %+1.2lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>, REGS<span class="o">[</span>2<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">831</span>       %1.8llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">8</span>               
</span></span><span class="line"><span class="cl"><span class="m">838</span>       %1.4096llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4096</span>             
</span></span><span class="line"><span class="cl"><span class="m">848</span>       %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">854</span>       %0.1lE                        XOR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">860</span>       %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">867</span>       %2.1047515510llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1047515510</span>       
</span></span><span class="line"><span class="cl"><span class="m">883</span>       %2.0lE                        XOR REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">889</span>       %1.8llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">8</span>               
</span></span><span class="line"><span class="cl"><span class="m">896</span>       %1.6144llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">6144</span>             
</span></span><span class="line"><span class="cl"><span class="m">906</span>       %+1.2lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>, REGS<span class="o">[</span>2<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">913</span>       %1.12llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">12</span>              
</span></span><span class="line"><span class="cl"><span class="m">921</span>       %1.4096llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4096</span>             
</span></span><span class="line"><span class="cl"><span class="m">931</span>       %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">937</span>       %0.1lE                        XOR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">943</span>       %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">950</span>       %2.359499514llS               ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">359499514</span>        
</span></span><span class="line"><span class="cl"><span class="m">965</span>       %2.1724461856llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1724461856</span>       
</span></span><span class="line"><span class="cl"><span class="m">981</span>       %2.0lE                        XOR REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">987</span>       %1.12llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">12</span>              
</span></span><span class="line"><span class="cl"><span class="m">995</span>       %1.6144llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">6144</span>             
</span></span><span class="line"><span class="cl"><span class="m">1005</span>      %+1.2lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>, REGS<span class="o">[</span>2<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1012</span>      %1.16llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">16</span>              
</span></span><span class="line"><span class="cl"><span class="m">1020</span>      %1.4096llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4096</span>             
</span></span><span class="line"><span class="cl"><span class="m">1030</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1036</span>      %0.1lE                        XOR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1042</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1049</span>      %2.241024035llS               ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">241024035</span>        
</span></span><span class="line"><span class="cl"><span class="m">1064</span>      %2.0lE                        XOR REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1070</span>      %1.16llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">16</span>              
</span></span><span class="line"><span class="cl"><span class="m">1078</span>      %1.6144llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">6144</span>             
</span></span><span class="line"><span class="cl"><span class="m">1088</span>      %+1.2lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>, REGS<span class="o">[</span>2<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1095</span>      %1.20llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">20</span>              
</span></span><span class="line"><span class="cl"><span class="m">1103</span>      %1.4096llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4096</span>             
</span></span><span class="line"><span class="cl"><span class="m">1113</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1119</span>      %0.1lE                        XOR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1125</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1132</span>      %2.222267724llS               ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">222267724</span>        
</span></span><span class="line"><span class="cl"><span class="m">1147</span>      %2.0lE                        XOR REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1153</span>      %1.20llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">20</span>              
</span></span><span class="line"><span class="cl"><span class="m">1161</span>      %1.6144llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">6144</span>             
</span></span><span class="line"><span class="cl"><span class="m">1171</span>      %+1.2lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>, REGS<span class="o">[</span>2<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1178</span>      %1.24llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">24</span>              
</span></span><span class="line"><span class="cl"><span class="m">1186</span>      %1.4096llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4096</span>             
</span></span><span class="line"><span class="cl"><span class="m">1196</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1202</span>      %0.1lE                        XOR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1208</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1215</span>      %2.844096018llS               ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">844096018</span>        
</span></span><span class="line"><span class="cl"><span class="m">1230</span>      %2.0lE                        XOR REGS<span class="o">[</span>2<span class="o">]</span>, REGS<span class="o">[</span>0<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1236</span>      %1.24llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">24</span>              
</span></span><span class="line"><span class="cl"><span class="m">1244</span>      %1.6144llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">6144</span>             
</span></span><span class="line"><span class="cl"><span class="m">1254</span>      %+1.2lM                       LOAD MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>, REGS<span class="o">[</span>2<span class="o">]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1261</span>      RET
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1262</span>      %0.0llM                       LOAD REGS<span class="o">[</span>0<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1269</span>      %1.0llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1276</span>      %1.4500llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4500</span>             
</span></span><span class="line"><span class="cl"><span class="m">1286</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1292</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1299</span>      %2.1374542625llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1374542625</span>       
</span></span><span class="line"><span class="cl"><span class="m">1315</span>      %2.1686915720llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1686915720</span>       
</span></span><span class="line"><span class="cl"><span class="m">1331</span>      %2.1129686860llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1129686860</span>       
</span></span><span class="line"><span class="cl"><span class="m">1347</span>      %1.2lE                        XOR REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1353</span>      %0.1lU                        OR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>           
</span></span><span class="line"><span class="cl"><span class="m">1359</span>      %1.4llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4</span>               
</span></span><span class="line"><span class="cl"><span class="m">1366</span>      %1.4500llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4500</span>             
</span></span><span class="line"><span class="cl"><span class="m">1376</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1382</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1389</span>      %2.842217029llS               ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">842217029</span>        
</span></span><span class="line"><span class="cl"><span class="m">1404</span>      %2.1483902564llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1483902564</span>       
</span></span><span class="line"><span class="cl"><span class="m">1420</span>      %1.2lE                        XOR REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1426</span>      %0.1lU                        OR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>           
</span></span><span class="line"><span class="cl"><span class="m">1432</span>      %1.8llM                       LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">8</span>               
</span></span><span class="line"><span class="cl"><span class="m">1439</span>      %1.4500llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4500</span>             
</span></span><span class="line"><span class="cl"><span class="m">1449</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1455</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1462</span>      %2.1868013731llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1868013731</span>       
</span></span><span class="line"><span class="cl"><span class="m">1478</span>      %1.2lE                        XOR REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1484</span>      %0.1lU                        OR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>           
</span></span><span class="line"><span class="cl"><span class="m">1490</span>      %1.12llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">12</span>              
</span></span><span class="line"><span class="cl"><span class="m">1498</span>      %1.4500llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4500</span>             
</span></span><span class="line"><span class="cl"><span class="m">1508</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1514</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1521</span>      %2.584694732llS               ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">584694732</span>        
</span></span><span class="line"><span class="cl"><span class="m">1536</span>      %2.1453312700llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1453312700</span>       
</span></span><span class="line"><span class="cl"><span class="m">1552</span>      %1.2lE                        XOR REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1558</span>      %0.1lU                        OR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>           
</span></span><span class="line"><span class="cl"><span class="m">1564</span>      %1.16llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">16</span>              
</span></span><span class="line"><span class="cl"><span class="m">1572</span>      %1.4500llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4500</span>             
</span></span><span class="line"><span class="cl"><span class="m">1582</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1588</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1595</span>      %2.223548744llS               ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">223548744</span>        
</span></span><span class="line"><span class="cl"><span class="m">1610</span>      %1.2lE                        XOR REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1616</span>      %0.1lU                        OR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>           
</span></span><span class="line"><span class="cl"><span class="m">1622</span>      %1.20llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">20</span>              
</span></span><span class="line"><span class="cl"><span class="m">1630</span>      %1.4500llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4500</span>             
</span></span><span class="line"><span class="cl"><span class="m">1640</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1646</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1653</span>      %2.1958883726llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1958883726</span>       
</span></span><span class="line"><span class="cl"><span class="m">1669</span>      %2.1916008099llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1916008099</span>       
</span></span><span class="line"><span class="cl"><span class="m">1685</span>      %1.2lE                        XOR REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1691</span>      %0.1lU                        OR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>           
</span></span><span class="line"><span class="cl"><span class="m">1697</span>      %1.24llM                      LOAD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">24</span>              
</span></span><span class="line"><span class="cl"><span class="m">1705</span>      %1.4500llS                    ADD REGS<span class="o">[</span>1<span class="o">]</span>, <span class="m">4500</span>             
</span></span><span class="line"><span class="cl"><span class="m">1715</span>      %1.1hM                        LOAD REGS<span class="o">[</span>1<span class="o">]</span>, MEM<span class="o">[</span>REGS<span class="o">[</span>1<span class="o">]]</span>    
</span></span><span class="line"><span class="cl"><span class="m">1721</span>      %2.0llM                       LOAD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">0</span>               
</span></span><span class="line"><span class="cl"><span class="m">1728</span>      %2.1829937605llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1829937605</span>       
</span></span><span class="line"><span class="cl"><span class="m">1744</span>      %2.1815356086llS              ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">1815356086</span>       
</span></span><span class="line"><span class="cl"><span class="m">1760</span>      %2.253836698llS               ADD REGS<span class="o">[</span>2<span class="o">]</span>, <span class="m">253836698</span>        
</span></span><span class="line"><span class="cl"><span class="m">1775</span>      %1.2lE                        XOR REGS<span class="o">[</span>1<span class="o">]</span>, REGS<span class="o">[</span>2<span class="o">]</span>          
</span></span><span class="line"><span class="cl"><span class="m">1781</span>      %0.1lU                        OR REGS<span class="o">[</span>0<span class="o">]</span>, REGS<span class="o">[</span>1<span class="o">]</span>           
</span></span><span class="line"><span class="cl"><span class="m">1787</span>      RET
</span></span></code></pre></div><p>Quite lengthy code, and actually because I have a working emulator, I didn&rsquo;t bother understand all of it. But there are some important points that must be noticed:</p>
<ul>
<li>The function at <code>MEM[200]</code> calls <code>MEM[500]</code> then <code>MEM[1262]</code>.</li>
<li>The function at <code>MEM[500]</code> accesses <code>MEM[4096]</code>, which is our input.</li>
<li>The function at <code>MEM[1262]</code> is called after <code>MEM[500]</code>, and there is a conditional call <code>CEZ REGS[0], 653</code> at <code>MEM[244]</code> after it returns.</li>
<li>The function at <code>MEM[653]</code> accesses <code>MEM[4096]</code> and <code>MEM[6144]</code>, which is where I suspected the flag to be, so this is probably where the flag is decrypted.</li>
</ul>
<p>Therefore, we want to get to <code>MEM[653]</code>, which means that <code>REGS[0]</code> must equal to 0 after <code>MEM[1262]</code>. This was enough information for me to insert <code>z3</code> in and let it solve everything for me.</p>
<h2 id="inserting-z3">Inserting z3</h2>
<p>The first step is to insert <code>z3</code> into our input. By looking at the function at <code>MEM[500]</code>, <code>MEM[1262]</code> and <code>MEM[653]</code>, we can see that the correct input is probably 28 bytes in length. Because we already knew the first byte, I declared 27 <code>BitVec</code> for the rest 27.</p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>Warning<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">*The <code>BitVec</code>s MUST be declared as 32-bit instead of 8-bit !!! The reason is all the calculations in this VM is 32-bit, if you declare the <code>BitVec</code> to be 8-bit it will truncate the result to 8-bit and ruin the calculations. This costs me like 2-3 hours to figure out.</div>
        </div>
    </div>
<p>Some changes need to be made for the emulator:</p>
<ul>
<li>We know that the real code starts at <code>MEM[200]</code>, so I declared <code>z3</code> variables when the VM hits <code>MEM[200]</code>.</li>
<li>The function at <code>MEM[500]</code> accesses our input, at <code>MEM[531]</code> there is a comparison with our input. Because our input is <code>z3</code> variables now, it will cause <code>python</code> to raise an exception when using <code>z3</code> variables in a <code>if-else</code> condition. Therefore, I made it so that it always returns <code>True</code> at <code>MEM[531]</code> if <code>z3</code> variables is in the condition.</li>
<li>We know the comparison is at <code>MEM[244]</code>, so I add the <code>z3</code> constraint when the VM reaches there.</li>
</ul>
<p>The full solver/emulator/disassembler is at <a href="/posts/20210719-ggctf2021-writeups/a.py" rel="">a.py</a>. Let it run for a while and it will give us the correct input: <code>TheNewFlagHillsByTheCtfWoods</code>.</p>
<p>Run the binary normally and input that string, we get the flag: <code>CTF{curs3d_r3curs1ve_pr1ntf}</code></p>
<h2 id="appendix">Appendix</h2>
<p>The full solver/emulator/disassembler is at <a href="/posts/20210719-ggctf2021-writeups/a.py" rel="">a.py</a>.</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-07-19</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://lkmidas.github.io/posts/20210719-ggctf2021-writeups/" data-title="GoogleCTF2021 - weather writeups" data-via="_lkmidas"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://lkmidas.github.io/posts/20210719-ggctf2021-writeups/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://lkmidas.github.io/posts/20210719-ggctf2021-writeups/" data-title="GoogleCTF2021 - weather writeups"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://lkmidas.github.io/posts/20210719-ggctf2021-writeups/" data-title="GoogleCTF2021 - weather writeups"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on " data-sharer="weibo" data-url="https://lkmidas.github.io/posts/20210719-ggctf2021-writeups/" data-title="GoogleCTF2021 - weather writeups"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/20210517-omhctf2021-writeups/" class="prev" rel="prev" title="OMHCTF2021 - Flag saver, GRUB writeups"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>OMHCTF2021 - Flag saver, GRUB writeups</a>
            <a href="/posts/20220704-ggctf2022-writeups/" class="next" rel="next" title="GoogleCTF2022 - eldar writeups">GoogleCTF2022 - eldar writeups<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.99.1">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":60},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-HGQHGNF9HJ');
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-HGQHGNF9HJ" async></script></body>
</html>
