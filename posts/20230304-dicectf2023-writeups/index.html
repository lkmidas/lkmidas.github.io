<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>DiceCTF 2023 Solana Challenges Write-up - Midas Blog</title><meta name="Description" content="Write-up for DiceCTF 2023 Solana challenges"><meta property="og:title" content="DiceCTF 2023 Solana Challenges Write-up" />
<meta property="og:description" content="Write-up for DiceCTF 2023 Solana challenges" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lkmidas.github.io/posts/20230304-dicectf2023-writeups/" /><meta property="og:image" content="https://lkmidas.github.io/images/avatar.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-04T15:44:42-06:00" />
<meta property="article:modified_time" content="2023-03-04T15:44:42-06:00" /><meta property="og:site_name" content="My cool site" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://lkmidas.github.io/images/avatar.png"/>

<meta name="twitter:title" content="DiceCTF 2023 Solana Challenges Write-up"/>
<meta name="twitter:description" content="Write-up for DiceCTF 2023 Solana challenges"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://lkmidas.github.io/posts/20230304-dicectf2023-writeups/" /><link rel="prev" href="https://lkmidas.github.io/posts/20230303-idekctf2022-writeups/" /><link rel="next" href="https://lkmidas.github.io/posts/20230828-sekaictf2023-writeups/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "DiceCTF 2023 Solana Challenges Write-up",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/lkmidas.github.io\/posts\/20230304-dicectf2023-writeups\/"
        },"genre": "posts","wordcount":  1789 ,
        "url": "https:\/\/lkmidas.github.io\/posts\/20230304-dicectf2023-writeups\/","datePublished": "2023-03-04T15:44:42-06:00","dateModified": "2023-03-04T15:44:42-06:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Midas"
            },"description": "Write-up for DiceCTF 2023 Solana challenges"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Midas Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" /></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Midas Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" /></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">DiceCTF 2023 Solana Challenges Write-up</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Midas</a></span>&nbsp;<span class="post-category">included in <a href="/categories/writeups/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>writeups</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-03-04">2023-03-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1789 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;9 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#dicectf-2023---baby-solana">DiceCTF 2023 - Baby Solana</a>
      <ul>
        <li><a href="#given-files">Given Files</a></li>
        <li><a href="#the-target-contract-functionalities">The target contract functionalities</a></li>
        <li><a href="#the-server-program">The server program</a></li>
        <li><a href="#the-vulnerabilities">The vulnerabilities</a></li>
      </ul>
    </li>
    <li><a href="#dicectf-2023---otterworld">DiceCTF 2023 - Otterworld</a>
      <ul>
        <li><a href="#given-files-1">Given Files</a></li>
        <li><a href="#the-target-contract-functionalities-1">The target contract functionalities</a></li>
        <li><a href="#the-server-program-1">The server program</a></li>
        <li><a href="#the-solution">The solution</a></li>
      </ul>
    </li>
    <li><a href="#appendix">Appendix</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><em>Use the table of contents on the right to navigate to the section that you are interested in.</em></div>
        </div>
    </div>
<h2 id="dicectf-2023---baby-solana">DiceCTF 2023 - Baby Solana</h2>
<h3 id="given-files">Given Files</h3>
<p>The challenge is written using the Anchor Framework, and the file structure is exactly the same as the other Anchor challenges that I&rsquo;ve written about in my previous posts. Some of the important files are:</p>
<ul>
<li><code>framework/chall/program/chall/src/lib.rs</code>: the implementation of the target contract.</li>
<li><code>framework/chall/src/main.rs</code>: the implementation of the initializations on the server using <a href="https://github.com/otter-sec/sol-ctf-framework" target="_blank" rel="noopener noreffer ">Solana CTF Framework</a>.</li>
<li><code>framework-solve/solve/program/solve/src/lib.rs</code> and <code>framework-solve/solve/src/main.rs</code>: the implementaion of our exploit contract and the its invocation.</li>
</ul>
<h3 id="the-target-contract-functionalities">The target contract functionalities</h3>
<p>This contract creates a liquidity pool with two assets, <code>x</code> and <code>y</code>. It contains several instructions, most of which are setters for the fields of the <code>state</code> account.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#[account(zero_copy)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(BorshSerialize, BorshDeserialize)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">FeeManager</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">timestamp</span>: <span class="kt">i64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">authority</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Pubkey</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[account(zero_copy)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">fee</span>: <span class="nc">NUMBER</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">x</span>: <span class="nc">NUMBER</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">y</span>: <span class="nc">NUMBER</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">enabled</span>: <span class="nc">FLAG</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">owner</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Pubkey</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">fee_manager</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">FeeManager</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>As usual, the first instruction is the <code>Init</code> instruction, which is similar to the <code>Initialize</code> instruction in the idekCTF Blockchain challenge mentioned in the previous post. The <code>Init</code> instruction was vulnerable in that challenge, so it is important to pay attention to it here as well.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="n">ctx</span>: <span class="nc">Context</span><span class="o">&lt;</span><span class="n">Init</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">load_init</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">payer</span><span class="p">.</span><span class="n">key</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Accounts)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Init</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(
</span></span></span><span class="line"><span class="cl"><span class="cp">        init,
</span></span></span><span class="line"><span class="cl"><span class="cp">        seeds = [ FLAG_SEED ],
</span></span></span><span class="line"><span class="cl"><span class="cp">        bump,
</span></span></span><span class="line"><span class="cl"><span class="cp">        payer = payer,
</span></span></span><span class="line"><span class="cl"><span class="cp">        space = 1000
</span></span></span><span class="line"><span class="cl"><span class="cp">    )]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state</span>: <span class="nc">AccountLoader</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(mut)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">payer</span>: <span class="nc">Signer</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">system_program</span>: <span class="nc">Program</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">rent</span>: <span class="nc">Sysvar</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Rent</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>There are also five setter instructions: <code>InitVirtualBalance</code>, <code>SetEnabled</code>, <code>SetFeeManager</code>, <code>SetOwner</code>, and <code>SetFee</code>. These instructions set the values of different fields in the global <code>state</code> account. For example, <code>InitVirtualBalance</code> sets the initial balance of the <code>x</code> and <code>y</code> assets, while <code>SetEnabled</code> sets the enabled flag used in the <code>Swap</code> instruction&rsquo;s constraint. <code>SetFeeManager</code> sets the fee manager account of ther current state, this account will be able to set the swapping fee via <code>SetFee</code>.
Finally, <code>SetOwner</code> can be used to change the owner of the contract.</p>
<p>The instructions use two account contexts: <code>Auth</code> and <code>AuthFee</code>. <code>InitVirtualBalance</code>, <code>SetFeeManager</code>, and <code>SetOwner</code> use <code>Auth</code>, while <code>SetEnabled</code> and <code>SetFee</code> use <code>AuthFee</code>. The <code>state</code> account constraints determine who can use each instruction. Only the contract owner can use instructions that use <code>Auth</code>, while the contract owner or the fee manager can use instructions that use <code>AuthFee</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#[derive(Accounts)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Auth</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(mut,
</span></span></span><span class="line"><span class="cl"><span class="cp">        constraint = (state.load().unwrap().owner.is_some() &amp;&amp; 
</span></span></span><span class="line"><span class="cl"><span class="cp">            state.load().unwrap().owner.unwrap() == payer.key()
</span></span></span><span class="line"><span class="cl"><span class="cp">        )
</span></span></span><span class="line"><span class="cl"><span class="cp">    )]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state</span>: <span class="nc">AccountLoader</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(mut)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">payer</span>: <span class="nc">Signer</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">system_program</span>: <span class="nc">Program</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">rent</span>: <span class="nc">Sysvar</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Rent</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Accounts)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AuthFee</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(mut,
</span></span></span><span class="line"><span class="cl"><span class="cp">        constraint = (state.load().unwrap().owner.is_some() &amp;&amp; 
</span></span></span><span class="line"><span class="cl"><span class="cp">            state.load().unwrap().owner.unwrap() == payer.key()
</span></span></span><span class="line"><span class="cl"><span class="cp">        ) || 
</span></span></span><span class="line"><span class="cl"><span class="cp">        (state.load().unwrap().fee_manager.is_some() &amp;&amp; (
</span></span></span><span class="line"><span class="cl"><span class="cp">            state.load().unwrap().fee_manager.unwrap().timestamp &lt; Clock::get()?.unix_timestamp &amp;&amp; 
</span></span></span><span class="line"><span class="cl"><span class="cp">            (
</span></span></span><span class="line"><span class="cl"><span class="cp">                state.load().unwrap().fee_manager.unwrap().authority.is_none() || 
</span></span></span><span class="line"><span class="cl"><span class="cp">                state.load().unwrap().fee_manager.unwrap().authority.unwrap() == payer.key()
</span></span></span><span class="line"><span class="cl"><span class="cp">            )
</span></span></span><span class="line"><span class="cl"><span class="cp">        ))
</span></span></span><span class="line"><span class="cl"><span class="cp">    )]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state</span>: <span class="nc">AccountLoader</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(mut)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">payer</span>: <span class="nc">Signer</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">system_program</span>: <span class="nc">Program</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">rent</span>: <span class="nc">Sysvar</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Rent</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Lastly, the <code>Swap</code> instruction can be used to &ldquo;exchange&rdquo; assets between <code>x</code> and <code>y</code> using a specific formula. It takes a single amount as input, adds it to both <code>x</code> and <code>y</code>, and then adds another amount calculated using the <code>fee</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">swap</span><span class="p">(</span><span class="n">ctx</span>: <span class="nc">Context</span><span class="o">&lt;</span><span class="n">Swap</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">amt</span>: <span class="nc">NUMBER</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">load_mut</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">fee</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">fee</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Accounts)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Swap</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(mut,
</span></span></span><span class="line"><span class="cl"><span class="cp">        constraint = state.load().unwrap().enabled
</span></span></span><span class="line"><span class="cl"><span class="cp">    )]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state</span>: <span class="nc">AccountLoader</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(mut)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">payer</span>: <span class="nc">Signer</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">system_program</span>: <span class="nc">Program</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">rent</span>: <span class="nc">Sysvar</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Rent</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="the-server-program">The server program</h3>
<p>The server program for this challenge is quite straightforward. Here are the steps it follows:</p>
<ol>
<li>Create the following accounts: <code>payer</code>, <code>user</code>and <code>state</code>.</li>
<li>Invoke the <code>Init</code> instruction with the <code>payer</code> as the owner account.</li>
<li>Invoke the <code>InitVirtualBalance</code> instruction with the <code>x</code> amount being 1,000,000 and <code>y</code> amount being 1,000,001.</li>
<li>Invoke the <code>SetEnabled</code> account, which means that the <code>Swap</code> instruction will be available for all users to use.</li>
<li>Run our exploit contract</li>
<li>Check if the <code>x</code> and <code>y</code> values are both 0. If they are, the flag is printed.</li>
</ol>
<p>It&rsquo;s clear that the objective is to somehow reduce the balance of all the assets in the pool to 0.</p>
<h3 id="the-vulnerabilities">The vulnerabilities</h3>
<p>To set the balances to 0, it is necessary to use instructions that can modify those values. There are two such instructions in this contract: <code>InitVirtualBalance</code> and <code>Swap</code>. However, only the contract owner can use the <code>InitVirtualBalance</code> instruction because it uses the <code>Auth</code> context. Therefore, the first attempt should be to try to become the owner. There are two ways to do this: either via the <code>Init</code> instruction or the <code>SetOwner</code> instruction. However, it is not possible to use the <code>SetOwner</code> instruction because it also uses the <code>Auth</code> context.</p>
<p>As mentioned before, the <code>Init</code> instruction is similar to the vulnerable instruction in the previous post. Therefore, the initial idea is to invoke this instruction and set oneself as the owner:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">accounts</span>::<span class="n">Init</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">payer</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">payer</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">system_program</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">system_program</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rent</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">rent</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">cpi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CpiContext</span>::<span class="n">new</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">chall</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">init</span><span class="p">(</span><span class="n">cpi_ctx</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>However, it&rsquo;s not as simple as it sounds. The transaction did not succeed and was immediately reverted. It took me some time to understand why, as the reason is not immediately obvious. Although the two instructions look very similar, there is one key difference between them:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="c1">// idekCTF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">config</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// DiceCTF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">load_init</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>The method <code>load_init()</code> is the key here. As <a href="https://docs.rs/anchor-lang/latest/anchor_lang/accounts/account_loader/struct.AccountLoader.html#method.load_init" target="_blank" rel="noopener noreffer ">documented in Anchor&rsquo;s documentation</a>, this method &ldquo;should only be called once, when the account is being initialized&rdquo;. Looking further into the <a href="https://docs.rs/anchor-lang/latest/src/anchor_lang/accounts/account_loader.rs.html#194-214" target="_blank" rel="noopener noreffer ">source code</a> of it, there exists these lines:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="n">discriminator</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ErrorCode</span>::<span class="n">AccountDiscriminatorAlreadySet</span><span class="p">.</span><span class="n">into</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>If the <code>state</code> account has already been initialized before, the <code>discriminator</code> will also have been initialized and will not be 0, which leads to an error and the transaction being reverted. Therefore, invoking <code>Init</code> is not a viable option in this case.</p>
<p>The only remaining option is to use <code>Swap</code>. Recall the formula used in this instruction:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">state</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">state</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">state</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">fee</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">state</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">fee</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>One obvious vulnerability that I haven&rsquo;t mentioned yet is that all integers in this contract are declared to be of the <code>NUMBER</code> type, which is defined as <code>i64</code>. This is a SIGNED type, which means negative values can be passed in. Since <code>state.x</code> and <code>state.y</code> are initialized to be 1,000,000 and 1,000,001 respectively, we can set <code>amt</code> to -1,000,000 and <code>state.fee</code> to -100 to make them both become 0 using the formula mentioned earlier. Setting <code>amt</code> is easy, as it&rsquo;s the argument of the instruction, but setting <code>state.fee</code> is not as simple. It is only possible to change this value using <code>SetFee</code>, which uses the <code>AuthFee</code> context. Since we cannot be the owner, we must be the fee manager to call this instruction. However, the fee manager can only be set using <code>SetFeeManager</code>, which again uses <code>Auth</code>! We&rsquo;re in a loop here where everything loops back to us needing to be the owner, which is impossible.</p>
<p>However, all hope is not lost. There is a line of code that I have already shown in this post, but have not mentioned yet:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#[account(zero_copy)]</span><span class="w">
</span></span></span></code></pre></div><p>Both the <code>State</code> and <code>FeeManager</code> accounts are defined to be <code>zero_copy</code>. According to the <a href="https://docs.rs/anchor-lang/latest/anchor_lang/attr.account.html" target="_blank" rel="noopener noreffer ">Anchor documentation</a>, to use the <code>zero_copy</code> attribute, &ldquo;all fields in an account must be constrained to be “plain old data”, i.e., they must implement Pod. Please review the <a href="https://docs.rs/bytemuck/latest/bytemuck/trait.Pod.html#safety" target="_blank" rel="noopener noreffer ">safety section</a> before using&rdquo;. However, this is not the case here. These accounts consist of several fields that are NOT plain old data, but are <code>Option&lt;&gt;</code> instead. <code>Option&lt;&gt;</code> is a Rust type that can either be <code>Some</code> and contain a value, or <code>None</code>, and not contain a value. We can see that in <code>AuthFee</code>, the constraints for <code>state</code> use the <code>is_some()</code> and <code>is_none()</code> method to check the validity of the fee manager account. However, since state is initialized with <code>zero_copy</code>, undefined behaviors occur. As a result, even though the fee manager was never set by the server setup program, it still somehow exists and IS NOT <code>None</code>, while its <code>authority</code> field IS <code>None</code>, passing all of the state account&rsquo;s constraints. This is an insane coincidence that allows any user to use the <code>SetFee</code> instruction.</p>
<p>The solution is simple now. We can simply call <code>SetFee</code> to set <code>state.fee</code> to -100, then <code>Swap</code> with <code>amt</code> equal to -1,000,000 to set both <code>x</code> and <code>y</code> to 0.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">accounts</span>::<span class="n">AuthFee</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">payer</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">payer</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">system_program</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">system_program</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rent</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">rent</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">cpi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CpiContext</span>::<span class="n">new</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">chall</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">set_fee</span><span class="p">(</span><span class="n">cpi_ctx</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">100</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">accounts</span>::<span class="n">Swap</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">payer</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">payer</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">system_program</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">system_program</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rent</span>: <span class="nc">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">rent</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">cpi_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CpiContext</span>::<span class="n">new</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">accounts</span><span class="p">.</span><span class="n">chall</span><span class="p">.</span><span class="n">to_account_info</span><span class="p">(),</span><span class="w"> </span><span class="n">cpi_accounts</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">chall</span>::<span class="n">cpi</span>::<span class="n">swap</span><span class="p">(</span><span class="n">cpi_ctx</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1_000_000</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>The flag for this challenge is <code>dice{z3r0_c0py_h3r0_c0py_cPDsolK8}</code></p>
<h2 id="dicectf-2023---otterworld">DiceCTF 2023 - Otterworld</h2>
<h3 id="given-files-1">Given Files</h3>
<p>The challenge is written using the Anchor Framework, and the file structure is exactly the same as the other Anchor challenges that I&rsquo;ve written about in my previous posts. Some of the important files are:</p>
<ul>
<li><code>framework/chall/program/chall/src/lib.rs</code>: the implementation of the target contract.</li>
<li><code>framework/chall/src/main.rs</code>: the implementation of the initializations on the server using <a href="https://github.com/otter-sec/sol-ctf-framework" target="_blank" rel="noopener noreffer ">Solana CTF Framework</a>.</li>
<li><code>framework-solve/solve/program/solve/src/lib.rs</code> and <code>framework-solve/solve/src/main.rs</code>: the implementaion of our exploit contract and the its invocation.</li>
</ul>
<h3 id="the-target-contract-functionalities-1">The target contract functionalities</h3>
<p>This challenge doesn&rsquo;t really resemble a real practical contract, but rather just a &ldquo;puzzle&rdquo;. The contract only implements one instruction, <code>GetFlag</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">_ctx</span>: <span class="nc">Context</span><span class="o">&lt;</span><span class="n">GetFlag</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Accounts)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">GetFlag</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(
</span></span></span><span class="line"><span class="cl"><span class="cp">        init,
</span></span></span><span class="line"><span class="cl"><span class="cp">        seeds = [ FLAG_SEED ],
</span></span></span><span class="line"><span class="cl"><span class="cp">        bump,
</span></span></span><span class="line"><span class="cl"><span class="cp">        payer = payer,
</span></span></span><span class="line"><span class="cl"><span class="cp">        space = 1000
</span></span></span><span class="line"><span class="cl"><span class="cp">    )]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">flag</span>: <span class="nc">Account</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Flag</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(
</span></span></span><span class="line"><span class="cl"><span class="cp">        constraint = password.key().as_ref()[..4] == b</span><span class="s">&#34;osec&#34;</span><span class="cp">[..]
</span></span></span><span class="line"><span class="cl"><span class="cp">    )]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">password</span>: <span class="nc">AccountInfo</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[account(mut)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">payer</span>: <span class="nc">Signer</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">system_program</span>: <span class="nc">Program</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">rent</span>: <span class="nc">Sysvar</span><span class="o">&lt;&#39;</span><span class="na">info</span><span class="p">,</span><span class="w"> </span><span class="n">Rent</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>This instruction initialize a <code>flag</code> account, but puts a very specific constraint on the <code>password</code> account: the first 4 bytes of its public key must be <code>b&quot;osec&quot;</code>.</p>
<h3 id="the-server-program-1">The server program</h3>
<p>The server program for this challenge simply checks if the <code>flag</code> account exists or not. If it does, the flag is printed. Therefore, it&rsquo;s clear that the objective is to pass the <code>password</code> account&rsquo;s constraint, so that the <code>GetFlag</code> instruction can be executed and initialized <code>flag</code>.</p>
<h3 id="the-solution">The solution</h3>
<p>I was surprised to find that this challenge had fewer solvers than Baby Solana, despite the fact that the solution is extremely simple. In Anchor, we have the option to create accounts with public keys of our choosing, rather than randomly generated ones. This can be done using the function <code>Pubkey::new_from_array()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">password_array</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="sc">b&#39;a&#39;</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">password_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">b&#39;o&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">password_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">b&#39;s&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">password_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">b&#39;e&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">password_array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">b&#39;c&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">new_from_array</span><span class="p">(</span><span class="n">password_array</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>Simply invoke the <code>GetFlag</code> instruction with this <code>password</code> account will give us the flag: <code>dice{0tt3r_w0r1d_8c01j3}</code></p>
<h2 id="appendix">Appendix</h2>
<ul>
<li>All challenge sources and solutions can be found <a href="https://github.com/lkmidas/Web3-CTF-Collection/tree/main/dicectf2023" target="_blank" rel="noopener noreffer ">here</a>.</li>
</ul></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-03-04</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://lkmidas.github.io/posts/20230304-dicectf2023-writeups/" data-title="DiceCTF 2023 Solana Challenges Write-up" data-via="_lkmidas"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://lkmidas.github.io/posts/20230304-dicectf2023-writeups/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://lkmidas.github.io/posts/20230304-dicectf2023-writeups/" data-title="DiceCTF 2023 Solana Challenges Write-up"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://lkmidas.github.io/posts/20230304-dicectf2023-writeups/" data-title="DiceCTF 2023 Solana Challenges Write-up"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://lkmidas.github.io/posts/20230304-dicectf2023-writeups/" data-title="DiceCTF 2023 Solana Challenges Write-up"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/20230303-idekctf2022-writeups/" class="prev" rel="prev" title="idekCTF 2022 Solana Challenges Write-up"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>idekCTF 2022 Solana Challenges Write-up</a>
            <a href="/posts/20230828-sekaictf2023-writeups/" class="next" rel="next" title="SekaiCTF 2023 Solana Challenge The Bidding Write-up">SekaiCTF 2023 Solana Challenge The Bidding Write-up<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.110.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":60},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-HGQHGNF9HJ');
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-HGQHGNF9HJ" async></script></body>
</html>
