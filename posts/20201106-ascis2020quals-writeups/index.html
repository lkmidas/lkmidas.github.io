<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>ASCIS2020 Quals - Findme, Crypt writeups - Midas Blog</title><meta name="Description" content="Writeups for ASCIS/SVATTT2020 Quals reversing challenges"><meta property="og:title" content="ASCIS2020 Quals - Findme, Crypt writeups" />
<meta property="og:description" content="Writeups for ASCIS/SVATTT2020 Quals reversing challenges" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lkmidas.github.io/posts/20201106-ascis2020quals-writeups/" />
<meta property="og:image" content="https://lkmidas.github.io/images/avatar.png"/>
<meta property="article:published_time" content="2020-11-06T05:56:39-08:00" />
<meta property="article:modified_time" content="2020-11-06T05:56:39-08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://lkmidas.github.io/images/avatar.png"/>

<meta name="twitter:title" content="ASCIS2020 Quals - Findme, Crypt writeups"/>
<meta name="twitter:description" content="Writeups for ASCIS/SVATTT2020 Quals reversing challenges"/>
<meta name="application-name" content="Midas Blog">
<meta name="apple-mobile-web-app-title" content="Midas Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://lkmidas.github.io/posts/20201106-ascis2020quals-writeups/" /><link rel="prev" href="https://lkmidas.github.io/posts/20201012-isitdtuctf2020quals-writeups/" /><link rel="next" href="https://lkmidas.github.io/posts/20201201-ascis2020final-writeups/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "ASCIS2020 Quals - Findme, Crypt writeups",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/lkmidas.github.io\/posts\/20201106-ascis2020quals-writeups\/"
        },"genre": "posts","wordcount":  1719 ,
        "url": "https:\/\/lkmidas.github.io\/posts\/20201106-ascis2020quals-writeups\/","datePublished": "2020-11-06T05:56:39-08:00","dateModified": "2020-11-06T05:56:39-08:00","publisher": {
            "@type": "Organization",
            "name": "Midas"},"author": {
                "@type": "Person",
                "name": "Midas"
            },"description": "Writeups for ASCIS/SVATTT2020 Quals reversing challenges"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Midas Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" /></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/lkmidas/lkmidas.blog" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Midas Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" /></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/lkmidas/lkmidas.blog" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">ASCIS2020 Quals - Findme, Crypt writeups</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Midas</a></span>&nbsp;<span class="post-category">included in <a href="/categories/writeups/"><i class="far fa-folder fa-fw"></i>writeups</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-11-06">2020-11-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1719 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;9 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#findme">findme</a>
      <ul>
        <li><a href="#analyzing-the-client">Analyzing the client</a></li>
        <li><a href="#analyzing-the-server">Analyzing the server</a></li>
        <li><a href="#solving-the-equations">Solving the equations</a></li>
        <li><a href="#appendix">Appendix</a></li>
      </ul>
    </li>
    <li><a href="#crypt">Crypt</a>
      <ul>
        <li><a href="#analyzing-crypt">Analyzing crypt</a></li>
        <li><a href="#retrieving-the-key">Retrieving the key</a></li>
        <li><a href="#decrypting-the-encrypted-file">Decrypting the encrypted file</a></li>
        <li><a href="#appendix-1">Appendix</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><em>Use the table of contents on the right to navigate to the challenge that you are interested in.</em></div>
        </div>
    </div>
<hr>
<h2 id="findme">findme</h2>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ul>
<li><strong>Given files:</strong> <a href="/posts/20201106-ascis2020quals-writeups/findme/findme.exe" rel="">findme.exe</a>.</li>
<li><strong>Category:</strong> Reverse engineering</li>
<li><strong>Summary:</strong> The given file is a Windows 32-bit PE file which reads in and checks a password. It actually acts as an RPC client, spawns an RPC server and communicates with it. It passes the password to the server and the server does the checking.</li>
</ul>
</div>
        </div>
    </div>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>TL;DR<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ol>
<li>Analyze the given binary -&gt; learn that it&rsquo;s an RPC client -&gt; dump the RPC server.</li>
<li>Analyze the server -&gt; find suspicious check function.</li>
<li>Write <code>z3</code> script to solve checking equations.</li>
</ol>
</div>
        </div>
    </div>
<h3 id="analyzing-the-client">Analyzing the client</h3>
<p>First off, I started to analyze the file statically. By looking at the <code>main</code> function, it is clear that this program reads an input password, then passes it to the checking function using the <strong>Remote procedure call</strong> (RPC) protocol, I knew this because the program makes calls to <code>RpcStringBindingComposeA</code>, <code>RpcBindingFromStringBindingA</code> and <code>NdrClientCall2</code> (although at the time, I knew nothing about RPC).</p>
<p>By reading the documentation from Microsoft about RPC and also doing some googling, I knew that this is a server - client protocol, and our program is acting as a client (RPC is always initiated by the client). Therefore, there must be a server running somewhere, but I couldn&rsquo;t find the part where the program initiates the server in <code>main</code>.</p>
<p>Initially, my suspect was that the server is initiated somewhere before <code>main</code>, in the initialization process of the PE. But I thought that looking into it would cost too much time, so I went the easier way, which is using the debugger attach option of IDA to list all the processes running in the system, and I found out that there was a dll running in the <code>%TEMP%</code> folder of Windows, and this probably was the server (I renamed it too <a href="/posts/20201106-ascis2020quals-writeups/findme/server.dll" rel="">server.dll</a>).</p>
<h3 id="analyzing-the-server">Analyzing the server</h3>
<p>I opened up the dll in IDA, there is a lot of functions, and most of the calls are (maybe) obfuscated in the way that they are called indirectly by some pointers in the data segment. Again, the client passes the password to the server using <code>NdrClientCall2</code>, one of the parameter of that function is a <em>MIDL-generated procedure format string</em>, which indicates what function will be called in the server. I did some googling to try and understand this parameter, but I didn&rsquo;t find much information, so I just looked at all the functions in the server dll one by one, and the most interesting function is the first function <code>sub_401000</code>, which only takes in 1 parameter and passes it to a lot of bitwise equations and finally returns a boolean value, and that seems likely to be the password checking function.</p>
<h3 id="solving-the-equations">Solving the equations</h3>
<p>So then, I simply wrote a python script to solve the equations using <code>z3</code>, the checking process is pretty simple: it checks if the length of the password is 16, and then do a series of calculations that form 16 equations. The script is as follow:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="n">BitVec</span><span class="p">,</span> <span class="n">Solver</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
	<span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BitVec</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="n">v1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>
<span class="n">v32</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
<span class="n">v31</span> <span class="o">=</span> <span class="n">v1</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">^</span> <span class="n">v1</span>
<span class="n">v3</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
<span class="n">v4</span> <span class="o">=</span> <span class="n">v3</span> <span class="o">^</span> <span class="n">v2</span>
<span class="n">v5</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="n">v6</span> <span class="o">=</span> <span class="n">v32</span> <span class="o">^</span> <span class="n">v3</span> <span class="o">^</span> <span class="n">v2</span>
<span class="n">v33</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
<span class="n">v35</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
<span class="n">v43</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<span class="n">v44</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="n">v34</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="n">v42</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">v29</span> <span class="o">=</span> <span class="n">v32</span> <span class="o">^</span> <span class="n">v2</span>
<span class="n">v40</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">v41</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">v38</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">v36</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">v24</span> <span class="o">=</span> <span class="n">v43</span> <span class="o">^</span> <span class="n">v40</span> <span class="o">^</span> <span class="n">v36</span> <span class="o">^</span> <span class="n">v32</span> <span class="o">^</span> <span class="n">v2</span>
<span class="n">v37</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="n">v25</span> <span class="o">=</span> <span class="n">v43</span> <span class="o">^</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">v33</span> <span class="o">^</span> <span class="n">v5</span> <span class="o">^</span> <span class="n">v37</span> <span class="o">^</span> <span class="n">v3</span> <span class="o">^</span> <span class="n">v35</span>
<span class="n">v26</span> <span class="o">=</span> <span class="n">v44</span> <span class="o">^</span> <span class="n">v42</span> <span class="o">^</span> <span class="n">v40</span> <span class="o">^</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">v37</span> <span class="o">^</span> <span class="n">v3</span> <span class="o">^</span> <span class="n">v35</span>
<span class="n">v30</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">^</span> <span class="n">v32</span>
<span class="n">v39</span> <span class="o">=</span> <span class="n">v3</span> <span class="o">^</span> <span class="n">v32</span> <span class="o">^</span> <span class="n">v35</span>
<span class="n">v27</span> <span class="o">=</span> <span class="n">v43</span> <span class="o">^</span> <span class="n">v44</span> <span class="o">^</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">v36</span> <span class="o">^</span> <span class="n">v37</span> <span class="o">^</span> <span class="n">v3</span> <span class="o">^</span> <span class="n">v2</span>
<span class="n">v28</span> <span class="o">=</span> <span class="n">v31</span> <span class="o">^</span> <span class="n">v3</span> <span class="o">^</span> <span class="n">v32</span> <span class="o">^</span> <span class="n">v35</span> <span class="o">^</span> <span class="n">v44</span> <span class="o">^</span> <span class="n">v42</span> <span class="o">^</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">v33</span> <span class="o">^</span> <span class="n">v36</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v35</span> <span class="o">^</span> <span class="p">(</span><span class="n">v43</span> <span class="o">^</span> <span class="n">v34</span> <span class="o">^</span> <span class="n">v40</span> <span class="o">^</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">v33</span> <span class="o">^</span> <span class="n">v5</span> <span class="o">^</span> <span class="n">v38</span> <span class="o">^</span> <span class="n">v36</span> <span class="o">^</span> <span class="n">v2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">117</span><span class="p">)</span>
<span class="n">v8</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v35</span> <span class="o">^</span> <span class="p">(</span><span class="n">v43</span> <span class="o">^</span> <span class="n">v44</span> <span class="o">^</span> <span class="n">v34</span> <span class="o">^</span> <span class="n">v42</span> <span class="o">^</span> <span class="n">v40</span> <span class="o">^</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">v6</span><span class="p">))</span> <span class="o">==</span> <span class="mi">49</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v44</span> <span class="o">^</span> <span class="p">(</span><span class="n">v34</span> <span class="o">^</span> <span class="n">v42</span> <span class="o">^</span> <span class="n">v5</span> <span class="o">^</span> <span class="n">v38</span> <span class="o">^</span> <span class="n">v37</span> <span class="o">^</span> <span class="n">v6</span><span class="p">))</span> <span class="o">==</span> <span class="mi">82</span><span class="p">)</span>
<span class="n">v10</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v35</span> <span class="o">^</span> <span class="p">(</span><span class="n">v43</span> <span class="o">^</span> <span class="n">v44</span> <span class="o">^</span> <span class="n">v34</span> <span class="o">^</span> <span class="n">v40</span> <span class="o">^</span> <span class="n">v41</span> <span class="o">^</span> <span class="n">v33</span> <span class="o">^</span> <span class="n">v4</span><span class="p">))</span> <span class="o">==</span> <span class="mi">102</span><span class="p">)</span>
<span class="n">v12</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v35</span> <span class="o">^</span> <span class="p">(</span><span class="n">v43</span> <span class="o">^</span> <span class="n">v34</span> <span class="o">^</span> <span class="n">v42</span> <span class="o">^</span> <span class="n">v40</span> <span class="o">^</span> <span class="n">v38</span> <span class="o">^</span> <span class="n">v36</span> <span class="o">^</span> <span class="n">v30</span><span class="p">))</span> <span class="o">==</span> <span class="mi">115</span><span class="p">)</span>
<span class="n">v13</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v44</span> <span class="o">^</span> <span class="p">(</span><span class="n">v42</span> <span class="o">^</span> <span class="n">v41</span> <span class="o">^</span> <span class="n">v12</span> <span class="o">^</span> <span class="n">v38</span> <span class="o">^</span> <span class="n">v36</span> <span class="o">^</span> <span class="n">v29</span><span class="p">))</span> <span class="o">==</span> <span class="mi">56</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v28</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v42</span> <span class="o">^</span> <span class="p">(</span><span class="n">v33</span> <span class="o">^</span> <span class="n">v12</span> <span class="o">^</span> <span class="n">v38</span> <span class="o">^</span> <span class="n">v36</span> <span class="o">^</span> <span class="n">v39</span><span class="p">))</span> <span class="o">==</span> <span class="mi">110</span><span class="p">)</span>
<span class="n">v16</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v27</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">v17</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v31</span> <span class="o">^</span> <span class="p">(</span><span class="n">v32</span> <span class="o">^</span> <span class="n">v35</span> <span class="o">^</span> <span class="n">v42</span> <span class="o">^</span> <span class="n">v41</span> <span class="o">^</span> <span class="n">v33</span> <span class="o">^</span> <span class="n">v12</span> <span class="o">^</span> <span class="n">v36</span><span class="p">))</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v26</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">v19</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v43</span> <span class="o">^</span> <span class="p">(</span><span class="n">v44</span> <span class="o">^</span> <span class="n">v41</span> <span class="o">^</span> <span class="n">v37</span> <span class="o">^</span> <span class="n">v39</span><span class="p">))</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v25</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">v21</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(((</span><span class="n">v43</span> <span class="o">^</span> <span class="p">(</span><span class="n">v34</span> <span class="o">^</span> <span class="n">v42</span> <span class="o">^</span> <span class="n">v38</span> <span class="o">^</span> <span class="n">v30</span><span class="p">))</span> <span class="o">==</span> <span class="mi">25</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v24</span> <span class="o">==</span> <span class="mi">78</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">v31</span> <span class="o">^</span> <span class="p">(</span><span class="n">v34</span> <span class="o">^</span> <span class="n">v40</span> <span class="o">^</span> <span class="n">v38</span> <span class="o">^</span> <span class="n">v37</span><span class="p">))</span> <span class="o">==</span> <span class="mi">48</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
<span class="n">ans</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
	<span class="n">result</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">as_long</span><span class="p">())</span>
<span class="k">print</span> <span class="n">result</span>
</code></pre></div><p>The password is <code>HkX~^=`asfWY^&amp;y&lt;</code>. Simply enter it into the client and get the flag:</p>
<pre><code>ASCIS{pl4y1ng_wi1h_RPC_i5_v3ry_4un}
</code></pre><h3 id="appendix">Appendix</h3>
<p>The dumped server binary is <a href="/posts/20201106-ascis2020quals-writeups/findme/server.dll" rel="">server.dll</a>.</p>
<p>The script for solving the password is <a href="/posts/20201106-ascis2020quals-writeups/findme/a.py" rel="">a.py</a>.</p>
<hr>
<h2 id="crypt">Crypt</h2>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ul>
<li><strong>Given files:</strong> <a href="/posts/20201106-ascis2020quals-writeups/Crypt/Crypt" rel="">Crypt</a>, <a href="/posts/20201106-ascis2020quals-writeups/Crypt/encrypted.bin" rel="">encrypted.bin</a>.</li>
<li><strong>Category:</strong> Reverse engineering</li>
<li><strong>Summary:</strong> The given <a href="/posts/20201106-ascis2020quals-writeups/Crypt/Crypt" rel="">Crypt</a> file is an ELF 64-bit executable compiled from C++ which takes 2 command line arguments: a key and a file name. It will check if the key is correct and then use it to somehow encrypt the file and generate <a href="/posts/20201106-ascis2020quals-writeups/Crypt/encrypted.bin" rel="">encrypted.bin</a>. The given <a href="/posts/20201106-ascis2020quals-writeups/Crypt/encrypted.bin" rel="">encrypted.bin</a> is the encrypted flag file, we have to reverse engineer the ELF file to find a way to decrypt this.</li>
</ul>
</div>
        </div>
    </div>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>TL;DR<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><ol>
<li>Analyze the given binary statically and dynamically -&gt; learn that it&rsquo;s a big number addition -&gt; retrieve the key.</li>
<li>Continue analyzing the next part -&gt; learn that it uses AES to encrypt the file.</li>
<li>Debug to get the AES key -&gt; decrypt <a href="/posts/20201106-ascis2020quals-writeups/Crypt/encrypted.bin" rel="">encrypted.bin</a></li>
</ol>
</div>
        </div>
    </div>
<h3 id="analyzing-crypt">Analyzing crypt</h3>
<p>First off, I started to analyze the file statically. The first thing that happened when I threw the program into IDA is that there were a bunch of errors about PLT. Skipping all those errors and looking into the file, it&rsquo;s obvious that all the library calls through PLT are obfuscated. The obfuscation scheme is not that difficult: the program has a table of all the pointers to the library functions (the same as GOT), and when it calls a library function, it makes some calls to some functions that literally get an offset from the start of that table to the desired function pointer. Therefore, it&rsquo;s not that hard to statically renamed all of the obfuscated library calls.</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Important Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><em><strong>There is actually no obfuscation in this phase! This is just the new ELF format with a <code>.plt.sec</code> section that IDA can&rsquo;t recognize and parse. The easiest way to parse it is to use <a href="https://github.com/veritas501/PltResolver" target="_blank" rel="noopener noreffer">PltResolver</a> plugin.</strong></em></div>
        </div>
    </div>
<h3 id="retrieving-the-key">Retrieving the key</h3>
<p>The comparison happens in the if statement using only 1 function <code>sub_45AE</code>, so using ANGR to try to solve the key is not a viable strategy (I did try it and failed horribly). Looking back up, I saw that three C++ strings were constructed, one from our input key, and two from the global variables <code>unk_9A80</code> and <code>unk_9AA0</code>. The values of these two variables are initialized somewhere in the initialization of the process and can be found by cross-referencing them, but they are really not that important because I decided to do this part dynamically anyway.</p>
<p>So, looking more carefully, our key and <code>unk_9AA0</code> go through a function <code>sub_411A</code>, by debugging, it&rsquo;s easy to recognize that this function simply mirror the string. The other variable <code>unk_9A80</code> in the other hand, goes through a series of function and then gets passed in to a final function <code>sub_47CC</code> together with our mirrored input key.</p>
<p>About that &ldquo;series of functions&rdquo;, I didn&rsquo;t even reverse them statically and just found the resulting string by debugging, it was <code>3669372743793841</code>.</p>
<p>About <code>sub_47CC</code>, it literally is just an addition function on two strings that represent large integers, where the leftmost digit being the least significant digit (that is why our strings are mirrored). The value of <code>unk_9AA0</code> after mirroring is <code>2333602996074364</code>. So in the end, all the key checking part does is to check if our input key satisfies this equation: <code>1483973472739663 + key == 4634706992063332</code>. Therefore, the key can be found by simple subtraction: <code>3150733519323669</code>.</p>
<h3 id="decrypting-the-encrypted-file">Decrypting the encrypted file</h3>
<p>After the key comparison is a bunch of C++ allocators and strings garbage that I simply just ignored. The important encryption function is under the for loop, function <code>sub_34C8</code>. Digging deep into this function, it is quite a complicated cryptographic function, so I looked for constants to find out if it is any of the popular crypto. I found an interesting array of constants <code>byte_9020</code>, which after some quick googling, I knew that this is called the <code>AES Sbox</code>. So this is for sure an AES encryption, the problem then was to know which AES mode it is, and what is the AES key.</p>
<p>For the key, it was just the matter of debugging with GDB again and dumping it out, which was <code>P4nd`p&lt;c8gE;T$F8</code>.</p>
<p>For the mode, I tried to create a file contains all character <code>a</code>, and encrypted it with the program. The result is that the encrypted file contains a bunch of the same blocks. I asked my team crypto player <a href="https://blog.efiens.com/author/pcback/" target="_blank" rel="noopener noreffer">@pcback</a> which mode of AES it is that makes the same cipher blocks for the same plain content, and he said it is <strong>AES ECB</strong>. With all the information, I just wrote a quick python script to decrypt the given encrypted file, which turns out to be a PNG image of the flag. The script is as follow:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>

<span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;P4nd`p&lt;c8gE;T$F8&#34;</span>
<span class="n">encrypt</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./encrypted.bin&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
<span class="nb">open</span><span class="p">(</span><span class="s2">&#34;out.png&#34;</span><span class="p">,</span><span class="s2">&#34;wb&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypt</span><span class="p">))</span>
</code></pre></div><p>The flag is:</p>
<pre><code>ASCIS{C4yp1o_1s_5impl3_b4t_C++_i5_cr4z9}
</code></pre><h3 id="appendix-1">Appendix</h3>
<p>The script to decrypt the encrypted file is <a href="/posts/20201106-ascis2020quals-writeups/Crypt/a.py" rel="">a.py</a>.</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2020-11-06</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/20201012-isitdtuctf2020quals-writeups/" class="prev" rel="prev" title="ISITDTUCTF2020 Quals - rev02 writeup"><i class="fas fa-angle-left fa-fw"></i>ISITDTUCTF2020 Quals - rev02 writeup</a>
            <a href="/posts/20201201-ascis2020final-writeups/" class="next" rel="next" title="ASCIS2020 Finals - RWE writeup">ASCIS2020 Finals - RWE writeup<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":60},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-HGQHGNF9HJ');
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-HGQHGNF9HJ" async></script></body>
</html>
